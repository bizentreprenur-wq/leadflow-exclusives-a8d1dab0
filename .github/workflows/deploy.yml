name: Deploy to Hostinger via FTP

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: |
          npm run build
          # Ensure Hostinger SPA routing file is deployed (our deploy uploads ./dist only)
          cp .htaccess dist/.htaccess

          # Bundle PHP backend into a separate artifact so the frontend deploy never touches /api
          rm -rf dist-api
          mkdir -p dist-api
          cp -a hostinger-backend/. dist-api/
          # Server-managed secrets must never be deployed from git
          rm -f dist-api/config.php dist-api/config.example.php
      - name: Deploy Frontend to Hostinger
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ./dist/
          # Hostinger typically serves your site from /public_html
          server-dir: /public_html/
          state-name: .ftp-deploy-frontend-state-v3.json
          dangerous-clean-slate: false
          # IMPORTANT: keep server-managed backend secrets intact
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            api
            api/**

      - name: Deploy Backend to Hostinger (/api)
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ./dist-api/
          server-dir: /public_html/api/
          state-name: .ftp-deploy-backend-state-v3.json
          dangerous-clean-slate: false
          # IMPORTANT: keep server-managed backend secrets & cache intact
          exclude: |
            config.php
            config.example.php
            cache/**
            cache

      - name: Verify API health (with retries)
        run: |
          API_URL="https://bamlead.com/api/health.php"
          MAX_ATTEMPTS=5
          RETRY_DELAY=10
          
          echo "üîç Running strict API health check..."
          echo "   URL: $API_URL"
          echo "   Max attempts: $MAX_ATTEMPTS"
          echo ""
          
          for ATTEMPT in $(seq 1 $MAX_ATTEMPTS); do
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            echo "Attempt $ATTEMPT of $MAX_ATTEMPTS"
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            
            # Fetch response with timeout
            RESPONSE=$(curl -s -w "\n%{http_code}" --max-time 30 "$API_URL" 2>&1)
            CURL_EXIT=$?
            
            if [ $CURL_EXIT -ne 0 ]; then
              echo "‚ùå curl failed with exit code $CURL_EXIT"
              if [ $ATTEMPT -lt $MAX_ATTEMPTS ]; then
                echo "   Retrying in ${RETRY_DELAY}s..."
                sleep $RETRY_DELAY
                continue
              fi
              echo ""
              echo "üö® DEPLOYMENT BLOCKED: API unreachable after $MAX_ATTEMPTS attempts"
              exit 1
            fi
            
            HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
            BODY=$(echo "$RESPONSE" | sed '$d')
            
            echo "HTTP Status: $HTTP_CODE"
            echo "Response body: $BODY"
            echo ""
            
            # Check 1: HTTP 200
            if [ "$HTTP_CODE" != "200" ]; then
              echo "‚ùå Failed: Expected HTTP 200, got $HTTP_CODE"
              if [ $ATTEMPT -lt $MAX_ATTEMPTS ]; then
                echo "   Retrying in ${RETRY_DELAY}s..."
                sleep $RETRY_DELAY
                continue
              fi
              echo ""
              echo "üö® DEPLOYMENT BLOCKED: API returned HTTP $HTTP_CODE"
              echo "   This usually means:"
              echo "   - The /api folder is missing on the server"
              echo "   - The health.php file was not deployed"
              echo "   - There's a server configuration issue"
              exit 1
            fi
            
            # Check 2: Response must be valid JSON (strict parse) with expected fields
            if ! echo "$BODY" | node -e 'let d="";process.stdin.on("data",c=>d+=c);process.stdin.on("end",()=>{try{const j=JSON.parse(d);if(!j||typeof j.status!=="string") throw new Error("Missing status");if(!j.checks||j.checks.api!==true) throw new Error("Missing checks.api");process.exit(0);}catch(e){console.error(e.message);process.exit(1);}});'; then
              echo "‚ùå Failed: Response is not valid BamLead health JSON"
              if [ $ATTEMPT -lt $MAX_ATTEMPTS ]; then
                echo "   Retrying in ${RETRY_DELAY}s..."
                sleep $RETRY_DELAY
                continue
              fi
              echo ""
              echo "üö® DEPLOYMENT BLOCKED: Invalid API response"
              echo "   Expected JSON like: { status, checks: { api: true } }"
              echo "   Got (first 300 chars):"
              echo "   $(echo "$BODY" | tr "\n" " " | sed 's/  */ /g' | cut -c1-300)"
              echo ""
              echo "   This usually means:"
              echo "   - /api is missing (Hostinger 404 HTML)"
              echo "   - PHP is crashing before it can output JSON"
              echo "   - You are hitting a different document root than the deploy"
              exit 1
            fi
            
            # Check 3: Status is not "error"
            if echo "$BODY" | grep -q '"status":\s*"error"'; then
              echo "‚ö†Ô∏è  API returned error status"
              echo "   The API is responding but reporting an internal error"
              # Don't block deployment for degraded status, just warn
            fi
            
            # All checks passed
            echo ""
            echo "‚úÖ API HEALTH CHECK PASSED"
            echo "   - HTTP 200 OK"
            echo "   - Valid JSON response"
            echo "   - API is operational"
            exit 0
          done
          
          echo ""
          echo "üö® DEPLOYMENT BLOCKED: Health check failed after $MAX_ATTEMPTS attempts"
          exit 1

