name: Deploy to Hostinger (Safe - Protects /api/)

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: üöö Checkout code
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: üêò Setup PHP for Composer
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          tools: composer

      - name: üèóÔ∏è Install and Build (Fixes ERESOLVE error)
        run: |
          # The next line uses --legacy-peer-deps to bypass the conflict
          # Skip onnxruntime-node binary download in CI; frontend uses web runtime
          npm ci --legacy-peer-deps --onnxruntime-node-install=skip
          npm run build

      - name: üì¶ Install API dependencies
        run: composer install --no-dev --prefer-dist --no-interaction --optimize-autoloader
        working-directory: ./api

      - name: üöÄ Deploy Frontend
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          port: 21
          local-dir: ./dist/
          server-dir: /home/u497238762/domains/bamlead.com/public_html/
          state-name: ftp-deploy-frontend-state.json
          dangerous-clean-slate: false
          exclude: |
            **/api/**
            **/chrome-extension/**
            **/config.php
            .git*
            node_modules/**

      - name: üöÄ Deploy Chrome Extension Assets (Hostinger-safe)
        env:
          FTP_HOST: ${{ secrets.FTP_SERVER }}
          FTP_USER: ${{ secrets.FTP_USERNAME }}
          FTP_PASS: ${{ secrets.FTP_PASSWORD }}
          REMOTE_DIR: /home/u497238762/domains/bamlead.com/public_html/chrome-extension
        run: |
          sudo apt-get update
          sudo apt-get install -y lftp

          # Hostinger FTP can fail with hidden temp-file renames (.in.*).
          # Use lftp mirror to upload files directly.
          lftp -c "
            set ftp:ssl-allow false;
            set net:max-retries 3;
            set net:timeout 30;
            set net:reconnect-interval-base 5;
            open -u \"$FTP_USER\",\"$FTP_PASS\" \"$FTP_HOST\";
            mkdir -p \"$REMOTE_DIR\";
            mirror -R --delete --verbose ./dist/chrome-extension \"$REMOTE_DIR\";
            bye
          "

      - name: üöÄ Deploy Backend
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          port: 21
          local-dir: ./api/
          server-dir: /home/u497238762/domains/bamlead.com/public_html/api/
          state-name: ftp-deploy-backend-state.json
          dangerous-clean-slate: false
          exclude: |
            **/config.php
            **/logs/**
            **/logs
