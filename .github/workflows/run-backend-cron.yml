name: Run Backend Cron Jobs

on:
  schedule:
    # GitHub Actions minimum schedule interval is 5 minutes.
    - cron: "*/5 * * * *"
  workflow_dispatch:

concurrency:
  group: backend-cron-jobs
  cancel-in-progress: false

jobs:
  run-cron:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Run cron-email.php and cron-followups.php on server
        uses: appleboy/ssh-action@v1.2.0
        env:
          API_DIR: /home/u497238762/domains/bamlead.com/public_html/api
          CRON_SECRET_KEY: ${{ secrets.CRON_SECRET_KEY }}
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          envs: API_DIR,CRON_SECRET_KEY
          script: |
            set -euo pipefail

            if [ -z "${CRON_SECRET_KEY:-}" ]; then
              echo "CRON_SECRET_KEY secret is missing."
              exit 1
            fi

            if [ ! -f "$API_DIR/cron-email.php" ] || [ ! -f "$API_DIR/cron-followups.php" ]; then
              echo "Cron scripts not found in $API_DIR"
              exit 1
            fi

            # CLI execution bypasses HTTP/IP restrictions for cron-email.php.
            php "$API_DIR/cron-email.php"

            # cron-followups.php currently expects ?key=... even in non-HTTP context.
            php -r '$_GET["key"]=getenv("CRON_SECRET_KEY"); require getenv("API_DIR")."/cron-followups.php";'
