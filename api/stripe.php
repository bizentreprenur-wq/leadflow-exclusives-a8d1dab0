<?php
/**
 * Stripe API Endpoints
 * Handles checkout, portal, and subscription management
 */

require_once __DIR__ . '/includes/functions.php';
require_once __DIR__ . '/includes/auth.php';
require_once __DIR__ . '/includes/stripe.php';

// Handle CORS
setCorsHeaders();
handlePreflight();

$action = $_GET['action'] ?? '';

switch ($action) {
    case 'create-checkout':
        handleCreateCheckout();
        break;
    case 'create-credits-checkout':
        handleCreateCreditsCheckout();
        break;
    case 'create-addon-checkout':
        handleCreateAddonCheckout();
        break;
    case 'create-portal':
        handleCreatePortal();
        break;
    case 'subscription':
        handleGetSubscription();
        break;
    case 'cancel':
        handleCancelSubscription();
        break;
    case 'resume':
        handleResumeSubscription();
        break;
    case 'history':
        handleGetPaymentHistory();
        break;
    case 'config':
        handleGetConfig();
        break;
    default:
        sendError('Invalid action', 400);
}

/**
 * Create checkout session for subscription
 */
function handleCreateCheckout() {
    if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
        sendError('Method not allowed', 405);
    }
    
    $user = requireAuth();
    $input = getJsonInput();
    
    $plan = sanitizeInput($input['plan'] ?? '', 20);
    $billingPeriod = sanitizeInput($input['billing_period'] ?? 'monthly', 10);
    
    if (!in_array($plan, ['basic', 'pro', 'autopilot', 'unlimited'])) {
        sendError('Invalid plan');
    }
    
    if (!in_array($billingPeriod, ['monthly', 'yearly'])) {
        sendError('Invalid billing period');
    }
    
    // Check if user is owner or has free account
    if ($user['is_owner'] || $user['subscription_plan'] === 'free_granted') {
        sendError('You already have unlimited access');
    }
    
    try {
        $session = createCheckoutSession($user, $plan, $billingPeriod);
        
        sendJson([
            'success' => true,
            'checkout_url' => $session->url,
            'session_id' => $session->id
        ]);
    } catch (Exception $e) {
        sendError($e->getMessage(), 500);
    }
}

/**
 * Create checkout session for one-time AI credit purchase
 */
function handleCreateCreditsCheckout() {
    if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
        sendError('Method not allowed', 405);
    }

    $user = requireAuth();
    $input = getJsonInput();
    $packageId = sanitizeInput($input['package'] ?? '', 20);

    $validPackages = ['starter', 'standard', 'pro', 'enterprise'];
    if (!in_array($packageId, $validPackages, true)) {
        sendError('Invalid credit package', 400);
    }

    try {
        $session = createCreditCheckoutSession($user, $packageId);
        sendJson([
            'success' => true,
            'checkout_url' => $session->url,
            'session_id' => $session->id,
        ]);
    } catch (Exception $e) {
        sendError($e->getMessage(), 500);
    }
}

/**
 * Create checkout session for add-on purchases (e.g., AI Calling $8/mo)
 */
function handleCreateAddonCheckout() {
    if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
        sendError('Method not allowed', 405);
    }

    $user = requireAuth();
    $input = getJsonInput();
    $addonId = sanitizeInput($input['addon'] ?? '', 20);

    $validAddons = ['ai_calling'];
    if (!in_array($addonId, $validAddons, true)) {
        sendError('Invalid add-on', 400);
    }

    try {
        $session = createAddonCheckoutSession($user, $addonId);
        sendJson([
            'success' => true,
            'checkout_url' => $session->url,
            'session_id' => $session->id,
        ]);
    } catch (Exception $e) {
        sendError($e->getMessage(), 500);
    }
}

/**
 * Create customer portal session
 */
function handleCreatePortal() {
    if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
        sendError('Method not allowed', 405);
    }
    
    $user = requireAuth();
    
    try {
        $session = createPortalSession($user);
        
        sendJson([
            'success' => true,
            'portal_url' => $session->url
        ]);
    } catch (Exception $e) {
        sendError($e->getMessage(), 500);
    }
}

/**
 * Get current subscription details
 */
function handleGetSubscription() {
    $user = requireAuth();
    
    $subscription = getUserSubscription($user['id']);
    
    sendJson([
        'success' => true,
        'subscription' => $subscription ? [
            'plan' => $subscription['plan_name'],
            'status' => $subscription['status'],
            'current_period_end' => $subscription['current_period_end'],
            'cancel_at_period_end' => (bool)$subscription['cancel_at_period_end'],
        ] : null,
        'is_owner' => (bool)$user['is_owner'],
        'is_free_account' => $user['subscription_plan'] === 'free_granted',
    ]);
}

/**
 * Cancel subscription
 */
function handleCancelSubscription() {
    if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
        sendError('Method not allowed', 405);
    }
    
    $user = requireAuth();
    $input = getJsonInput();
    $immediately = (bool)($input['immediately'] ?? false);
    
    try {
        cancelSubscription($user['id'], $immediately);
        
        sendJson([
            'success' => true,
            'message' => $immediately 
                ? 'Subscription canceled immediately'
                : 'Subscription will be canceled at the end of the billing period'
        ]);
    } catch (Exception $e) {
        sendError($e->getMessage(), 500);
    }
}

/**
 * Resume canceled subscription
 */
function handleResumeSubscription() {
    if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
        sendError('Method not allowed', 405);
    }
    
    $user = requireAuth();
    
    try {
        resumeSubscription($user['id']);
        
        sendJson([
            'success' => true,
            'message' => 'Subscription resumed'
        ]);
    } catch (Exception $e) {
        sendError($e->getMessage(), 500);
    }
}

/**
 * Get payment history
 */
function handleGetPaymentHistory() {
    $user = requireAuth();
    
    $history = getPaymentHistory($user['id']);
    
    sendJson([
        'success' => true,
        'payments' => array_map(function($payment) {
            return [
                'id' => $payment['id'],
                'amount' => $payment['amount'] / 100, // Convert from cents
                'currency' => strtoupper($payment['currency']),
                'status' => $payment['status'],
                'description' => $payment['description'],
                'date' => $payment['created_at'],
            ];
        }, $history)
    ]);
}

/**
 * Get public Stripe config
 */
function handleGetConfig() {
    sendJson([
        'success' => true,
        'publishable_key' => STRIPE_PUBLISHABLE_KEY,
        'plans' => [
            'basic' => [
                'name' => 'Basic',
                'monthly_price' => 49,
                'yearly_price' => 470,
                'features' => [
                    '50 searches per day',
                    'Basic lead verification',
                    'CSV export',
                    'Email support',
                ],
            ],
            'pro' => [
                'name' => 'Pro',
                'monthly_price' => 99,
                'yearly_price' => 950,
                'features' => [
                    '200 searches per day',
                    'Co-Pilot Mode: AI manages sequences',
                    'Smart Response Detection',
                    'Auto Follow-Up Sequences',
                    'Priority support',
                    'Team collaboration (3 users)',
                ],
            ],
            'autopilot' => [
                'name' => 'Autopilot',
                'monthly_price' => 249,
                'yearly_price' => 2390,
                'features' => [
                    'Unlimited searches',
                    'Agentic Mode: Full Autopilot',
                    'Autonomous Proposal Delivery',
                    'White-label reports',
                    'API access',
                    'Dedicated account manager',
                ],
            ],
            'unlimited' => [
                'name' => 'Unlimited',
                'monthly_price' => 999,
                'yearly_price' => 9590,
                'features' => [
                    'Unlimited everything â€” no credits needed',
                    'Dedicated AI Sales Brain',
                    'Dedicated agent guides your full setup',
                    'Full campaign buildout & ICP targeting',
                    'CRM + Calendar integration setup',
                ],
            ],
        ],
    ]);
}
